<!DOCTYPE html>
<html>
  <head>
    <title>Docker registry 로 개인 Docker 구축해보기 – Even Though ... 그럼에도 불구하고 열심히 – 작은 끄적거림</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="
" />
    <meta property="og:description" content="
" />
    
    <meta name="author" content="Even Though ... 그럼에도 불구하고 열심히" />

    
    <meta property="og:title" content="Docker registry 로 개인 Docker 구축해보기" />
    <meta property="twitter:title" content="Docker registry 로 개인 Docker 구축해보기" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Even Though ... 그럼에도 불구하고 열심히 - 작은 끄적거림" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="/images/xmlangel.jpg" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Even Though ... 그럼에도 불구하고 열심히</a></h1>
            <p class="site-description">작은 끄적거림</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Docker registry 로 개인 Docker 구축해보기</h1>

  <div class="entry">
    <ul id="markdown-toc">
  <li><a href="#vagrant-설정" id="markdown-toc-vagrant-설정"><a href="#vagrant">vagrant 설정</a></a></li>
  <li><a href="#docker-composeyml-에-nginx-와-registry-설정을한다" id="markdown-toc-docker-composeyml-에-nginx-와-registry-설정을한다">docker-compose.yml 에 nginx 와 registry 설정을한다.</a>    <ul>
      <li><a href="#setting-up-authentication" id="markdown-toc-setting-up-authentication">Setting Up Authentication</a>        <ul>
          <li><a href="#참고자료" id="markdown-toc-참고자료">참고자료</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>도커를 이용하면서 도커허브에 올리면 좋겠지만 내부에서 이용 하려고 할때 Open할수 없는 정보들이 있을수 있다.</p>

<p>하지만 private registry 를 이용하면 어느정도는 극복할수 있다.</p>

<p>사용할 환경은</p>
<ul>
  <li>Vagrant</li>
  <li>docker</li>
  <li>docker-compoose</li>
  <li>Ubuntu 14.04</li>
</ul>

<p>vagrant 를 이용하면 쉽게 구성이 가능하다.</p>

<h1 id="vagrant-설정"><a href="#vagrant">vagrant 설정</a></h1>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># -*- mode: ruby -*-</span>
<span class="c1"># vi: set ft=ruby :</span>

<span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s2">"opscode-ubuntu-14.04"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"private_network"</span><span class="p">,</span> <span class="ss">ip: </span><span class="s2">"11.168.20.1"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="s2">"public_network"</span><span class="p">,</span> <span class="ss">bridge: </span><span class="p">[</span>
    <span class="s2">"en0: Wi-Fi (AirPort)"</span>
    <span class="p">]</span>
  <span class="c1">#vagrant 에서 data 폴더를 공유해서사용 </span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./data"</span><span class="p">,</span> <span class="s2">"/vagrant_data"</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provision</span> <span class="s2">"shell"</span><span class="p">,</span> <span class="ss">inline: </span><span class="o">&lt;&lt;-</span><span class="no">SHELL</span><span class="sh">
   #한글 및 사용편위를 위한 패키지설치
   sudo sed -i 's/us.archive.ubuntu.com/ftp.daum.net/g' /etc/apt/sources.list
   sudo sed -i 's/security.archive.ubuntu.com/ftp.daum.net/g' /etc/apt/sources.list
   sudo apt-get update
   sudo apt-get install -y vim screen curl
   
   #Docker 설치
   sudo apt-get install apt-transport-https ca-certificates
   sudo apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
   echo "deb https://apt.dockerproject.org/repo ubuntu-trusty main"&gt;/etc/apt/sources.list.d/docker.list
   sudo apt-get update
   sudo apt-get install docker-engine -y
   sudo service docker start

   #Docker Compose 설치
   sudo apt-get -y install python-pip
   sudo pip install docker-compose

   #apache2-utils에 있는 htpasswd 를 사용하기위한 패키지 다운로드
   apt-get -y install apache2-utils

</span><span class="no">   SHELL</span>
<span class="k">end</span></code></pre></figure>

<p>ubuntu의 다른 버전이라면 docker.list파일에 아래의 내용으로 변경해서 설치하면된다.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c">### ubuntu 12.04</span>
deb https://apt.dockerproject.org/repo ubuntu-precise main

<span class="c">### ubuntu 14.04</span>
deb https://apt.dockerproject.org/repo ubuntu-trusty main

<span class="c">### ubuntu 15.10</span>
deb https://apt.dockerproject.org/repo ubuntu-wily main

<span class="c">### ubuntu 16.04</span>
deb https://apt.dockerproject.org/repo ubuntu-xenial main</code></pre></figure>

<h1 id="docker-composeyml-에-nginx-와-registry-설정을한다">docker-compose.yml 에 nginx 와 registry 설정을한다.</h1>

<p>vagrant 에서 vagrant_data 로 연결하였으므로, vagrant_data 에서 작업을 한다.</p>

<p>작업할 디랙토리 구조느 아래와 같다.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">root@vagrant:/vagrant# </span><span class="nb">cd</span> /vagrant_data
<span class="gp">root@vagrant:/vagrant_data# </span>tree
.
|-- data
|-- docker-compose.yml
|-- nginx
    |-- registry.conf</code></pre></figure>

<p>data 디랙토리와 nginx 디랙토리를 만들어준다.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">root@vagrant:/vagrant_data# </span>mkdir data
<span class="gp">root@vagrant:/vagrant_data# </span>mkdir nginx</code></pre></figure>

<p>data 디랙토리는 registry의 data 경로로 이용하고, nginx 는 nginx 설정파일이 저장될 위치이다.</p>

<ul>
  <li>docker-compose.yml</li>
</ul>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="ss">nginx:
  image: </span><span class="s2">"nginx:1.9"</span>
  <span class="ss">ports:
    </span><span class="o">-</span> <span class="mi">5043</span><span class="p">:</span><span class="mi">443</span>
  <span class="ss">links:
    </span><span class="o">-</span> <span class="n">registry</span><span class="ss">:registry</span>
  <span class="ss">volumes:
     </span><span class="o">-</span> <span class="p">.</span><span class="nf">/</span><span class="n">nginx</span><span class="o">/</span><span class="ss">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="nf">d</span>

<span class="ss">registry:
    image: </span><span class="s2">"registry:2"</span>
    <span class="ss">ports:
        </span><span class="o">-</span> <span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5000</span><span class="p">:</span><span class="mi">5000</span>
    <span class="ss">environment:
        </span><span class="no">REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY</span><span class="p">:</span> <span class="sr">/data
    volumes:
        - ./</span><span class="n">data</span><span class="ss">:/</span><span class="n">data</span></code></pre></figure>

<ul>
  <li>registry.conf</li>
</ul>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">upstream</span> <span class="n">docker</span><span class="o">-</span><span class="n">registry</span> <span class="p">{</span>
  <span class="n">server</span> <span class="n">registry</span><span class="p">:</span><span class="mi">5000</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">server</span> <span class="p">{</span>
  <span class="n">listen</span> <span class="mi">443</span><span class="p">;</span>
  <span class="n">server_name</span> <span class="n">myregistrydomain</span><span class="p">.</span><span class="nf">com</span><span class="p">;</span>

  <span class="c1"># SSL</span>
  <span class="c1"># ssl on;</span>
  <span class="c1"># ssl_certificate /etc/nginx/conf.d/domain.crt;</span>
  <span class="c1"># ssl_certificate_key /etc/nginx/conf.d/domain.key;</span>

  <span class="c1"># disable any limits to avoid HTTP 413 for large image uploads</span>
  <span class="n">client_max_body_size</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1"># required to avoid HTTP 411: see Issue #1486 (https://github.com/docker/docker/issues/1486)</span>
  <span class="n">chunked_transfer_encoding</span> <span class="n">on</span><span class="p">;</span>

  <span class="n">location</span> <span class="sr">/v2/</span> <span class="p">{</span>
    <span class="c1"># Do not allow connections from docker 1.5 and earlier</span>
    <span class="c1"># docker pre-1.6.0 did not properly set the user agent on ping, catch "Go *" user agents</span>
    <span class="k">if</span> <span class="p">(</span><span class="vg">$http_user_agent</span> <span class="o">~</span> <span class="s2">"^(docker</span><span class="se">\/</span><span class="s2">1</span><span class="se">\.</span><span class="s2">(3|4|5(?!</span><span class="se">\.</span><span class="s2">[0-9]-dev))|Go ).*$"</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">404</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1"># To add basic authentication to v2 use auth_basic setting plus add_header</span>
    <span class="c1"># auth_basic "registry.localhost";</span>
    <span class="c1"># auth_basic_user_file /etc/nginx/conf.d/registry.password;</span>
    <span class="c1"># add_header 'Docker-Distribution-Api-Version' 'registry/2.0' always;</span>

    <span class="n">proxy_pass</span>                          <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">registry</span><span class="p">;</span>
    <span class="n">proxy_set_header</span>  <span class="no">Host</span>              <span class="vg">$http_host</span><span class="p">;</span>   <span class="c1"># required for docker client's sake</span>
    <span class="n">proxy_set_header</span>  <span class="no">X</span><span class="o">-</span><span class="no">Real</span><span class="o">-</span><span class="no">IP</span>         <span class="vg">$remote_addr</span><span class="p">;</span> <span class="c1"># pass on real client's IP</span>
    <span class="n">proxy_set_header</span>  <span class="no">X</span><span class="o">-</span><span class="no">Forwarded</span><span class="o">-</span><span class="no">For</span>   <span class="vg">$proxy_add_x_forwarded_for</span><span class="p">;</span>
    <span class="n">proxy_set_header</span>  <span class="no">X</span><span class="o">-</span><span class="no">Forwarded</span><span class="o">-</span><span class="no">Proto</span> <span class="vg">$scheme</span><span class="p">;</span>
    <span class="n">proxy_read_timeout</span>                  <span class="mi">900</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>docker-compose 를 이용해서 docker 를 띄운후 결과를 확인해본다.</p>

<ul>
  <li>registry 에서 확인결과</li>
</ul>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">root@vagrant:/vagrant_data# </span>docker-compose up
<span class="gp">root@vagrant:/vagrant_data# </span>curl http://localhost:5000/v2/</code></pre></figure>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">Output
<span class="o">{}</span></code></pre></figure>

<ul>
  <li>nginx에서 확인결과</li>
</ul>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">root@vagrant:/vagrant_data# </span>docker-compose up
<span class="gp">root@vagrant:/vagrant_data# </span>curl http://127.0.0.1:5043/v2/</code></pre></figure>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">Output
<span class="o">{}</span></code></pre></figure>

<p>이제 정상적으로 동작하는것을 확인해보았다.</p>

<p>그럼 한번 Push 를 해보겠다.</p>

<p>내부에서 테스트를 해보려면.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>sudo docker run hello-world
<span class="gp">$ </span>sudo docker tag hello-world 127.0.0.1:5043/hello-world
<span class="gp">$ </span>sudo docker push 127.0.0.1:5043/hello-world</code></pre></figure>

<p>다른 클라이언트에서 접속해서하려면.(vagrant 이므로 11.168.20.1 로 아이피가 지정되어있으므로 해당 아이피로 host 머신에서 접속테스트해보면된다.)</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>sudo docker run hello-world
<span class="gp">$ </span>sudo docker tag hello-world 11.168.20.1:5043/hello-world
<span class="gp">$ </span>sudo docker push 127.0.0.1:5043/hello-world
<span class="gp">$ </span>sudo pull 11.168.20.1:5043/hello-world</code></pre></figure>

<h2 id="setting-up-authentication">Setting Up Authentication</h2>
<p>누구나 접근이 가능하게 하면 이또한 문제 그래서 htpasswd utlity 를 이용해서 접속하게 하는 방법을 해보겠다.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">cd</span> ~/docker-registry/nginx
htpasswd -c registry.password USERNAME</code></pre></figure>

<p>Username을 입력후 비빌번호를 입력해준다.
그런후</p>

<p>registry.conf를 변경해준다. 이미 위에서 입력한내용을 주석으로 풀어준다.
아래 내용의 주석을 풀어주면된다.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># To add basic authentication to v2 use auth_basic setting plus add_header</span>
auth_basic <span class="s2">"registry.localhost"</span>;
auth_basic_user_file /etc/nginx/conf.d/registry.password;
add_header <span class="s1">'Docker-Distribution-Api-Version'</span> <span class="s1">'registry/2.0'</span> always;</code></pre></figure>

<p>그런후 다시 실행해주면 인증이 필요하다고 한다.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">root@vagrant:/vagrant_data/#docker-compose down
root@vagrant:/vagrant_data/#docker-compose up -d 
<span class="gp">root@vagrant:/vagrant_data# </span>curl http://localhost:5043/v2/
&lt;html&gt;
&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;
&lt;body <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">"white"</span>&gt;
&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.9.15&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></figure>

<p>생성한 아이디와 패스워드를 입력하면 정상적으로 되는것을 확인할수 있다.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">root@vagrant:/vagrant_data# </span>curl http://USERNAME:PASSWORD@localhost:5043/v2/
<span class="o">{}</span>%</code></pre></figure>

<p>https  설정까지는 현재까지는 필요없어</p>

<p>일단 http 를 통해 사용자인증이 되는 환경까지는 구성됐다.</p>

<p>이제 이용하면 될것 같다..</p>

<p>https 는 다음을 위해 남겨놓고 오늘은 여기까지…</p>

<h4 id="참고자료">참고자료</h4>

<p><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-docker-registry-on-ubuntu-14-04">How To Set Up a Private Docker Registry on Ubuntu 14.04
</a></p>

<!-- http://gyus.me/?p=546 -->

<!-- 
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">print_hi</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Hi, </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
<span class="n">print_hi</span><span class="p">(</span><span class="s1">'Tom'</span><span class="p">)</span>
<span class="c1">#=&gt; prints 'Hi, Tom' to STDOUT.</span></code></pre></figure>

 -->

  </div>

  <div class="date">
    Written on March 11, 2017
  </div>
  <div class="comments">
	  
  </div>
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:kwangmyung.kim@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/xmlangel"><i class="svg-icon github"></i></a>








        </footer>
      </div>
    </div>

    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-55180057-2', 'auto');
		ga('send', 'pageview', {
		  'page': '/docker_registry_with_vagrant/',
		  'title': 'Docker registry 로 개인 Docker 구축해보기'
		});
	</script>
	<!-- End Google Analytics -->


  </body>
</html>
